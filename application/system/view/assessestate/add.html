<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>入户评估-房产评估|后台管理系统</title>
    {include file="public/head" /}
    {include file="public/kindeditor" /}
</head>
<body>
<form action="{:url('add')}" method="post" class="js-ajax-form" onsubmit="return false;">
    <div class="tabs">
        <div class="item">
            <div class="homeTit bg_f5">
                <div class="fl"><img src="__STATIC__/system/img/books.png"/>入户评估-房产评估</div>
                <ul class="homeTab">
                    <li class="on">基本信息</li>
                    <li>相关文件及图片</li>
                </ul>
            </div>
            <div class="homeCon">
                <div class="tabPage w_100 on">
                    <div class="layerCon bg_f">
                        <table class="layerTable" border="0">
                            <tr class="h50">
                                <td><label for="item_id">项目：</label></td>
                                <td>
                                    <select name="item_id" id="item_id" class="chosen sear_collection_id" data-placeholder="请选择项目" data-no_results_text="没有匹配数据">
                                        <option value="">--请选择项目--</option>
                                        {volist name="items" id="item"}
                                        <option value="{$item->id}" >{$item->name}（{$item->id}）</option>
                                        {/volist}
                                    </select>
                                </td>
                                <td><label for="community_id">片区：</label></td>
                                <td>
                                    <select name="community_id" id="community_id" class="chosen sear_collection_id" data-placeholder="请选择片区" data-no_results_text="没有匹配数据">
                                        <option value="">--请选择片区--</option>
                                        {volist name="collectioncommunitys" id="community"}
                                        <option value="{$community->id}" {if condition="isset($infos) and $infos->community_id eq $community->id"}selected{/if}>{$community->name}</option>
                                        {/volist}
                                    </select>
                                </td>
                            </tr>
                            <tr class="h70">
                                <td ><label for="collection_id">权属：</label></td>
                                <td id="collection_id_info" colspan="3">
                                    <select name="collection_id" id="collection_id" class="chosen" data-placeholder="请选择权属" data-no_results_text="没有匹配数据">
                                        <option value="">--请先选择项目--</option>
                                    </select>
                                </td>
                            </tr>
                            <tr class="h70">
                                <td ><label for="collection_id">所有建筑：</label></td>
                                <td colspan="3" class="tableCons">
                                    <table class="table" border="0">
                                        <tbody>
                                        <tr class="noSelect">
                                            <th style="width: inherit !important;">ID</th>
                                            <th>位置</th>
                                            <th>性质</th>
                                            <th>结构</th>
                                            <th>数量</th>
                                            <th>计量单位</th>
                                            <th>单价</th>
                                            <th>备注</th>
                                            <th>总价</th>
                                        </tr>
                                        </tbody>
                                    </table>
                                </td>
                            </tr>
                            <tr class="h50">
                                <td><label for="company_id">评估公司：</label></td>
                                <td colspan="3">
                                    <select name="company_id" id="company_id">
                                        <option value="">--请先选择项目--</option>
                                    </select>
                                </td>
                            </tr>
                            <tr class="h50">
                                <td><label for="valuer_id_info">评估师：</label>
                                    <input type="hidden" name="valuer_id" id="valuer_id" value="">
                                    <button class="btn valuerid_list"  onclick="valuer_id_list()">选择评估师</button>
                                </td>
                                <td id="valuer_id_info" colspan="3">
                                    <table class="table" border="0" id="valuer_id_lists">
                                        <tbody>
                                        <tr class="noSelect">
                                            <th style="text-align: center;">ID</th>
                                            <th style="text-align: center;">姓名</th>
                                            <th style="text-align: center;">注册号</th>
                                            <th style="text-align: center;">有效期</th>
                                        </tr>
                                        </tbody>
                                    </table>
                                </td>
                            </tr>
                            <tr class="h50">
                                <td><label for="report_at">报告时间：</label></td>
                                <td>
                                    <input type="text" class="laydate-icon" name="report_at" id="report_at" value="" placeholder="请输入报告时间">
                                </td>
                                <td><label for="valued_at">价值时点：</label></td>
                                <td>
                                    <input type="text" class="laydate-icon" name="valued_at" id="valued_at" value="" placeholder="请输入价值时点">
                                </td>
                            </tr>
                            <tr class="h50">
                                <td><label for="method">评估方法：</label></td>
                                <td>
                                    <input type="text" name="method" id="method" value="" placeholder="请输入评估方法">
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="tabPage w_100">
                    <div class="layerCon bg_f">
                        <table class="layerTable" border="0" id="picture-table">
                            <tr class="h70">
                                <td>评估报告：</td>
                                <td class="imgCon" colspan="3">
                                    {if condition="isset($infos) and $infos->picture"}
                                    {volist name="infos->picture" id="pic"}
                                    <div class="img">
                                        <img src="{$pic}" class="w_100 h_100" onclick="bigimg(this)">
                                        <p><span onclick="picremove(this);">删除</span></p>
                                        <input type="hidden" name="picture[]" value="{$pic}"/>
                                    </div>
                                    {/volist}
                                    {/if}
                                    <div class="img btn-upload" data-type="multiimage" data-hidename="picture[]"><a>+</a></div>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="layerBtns">
                    <a class="btn js-ajax-form-btn" data-layer="true" >立即提交</a>
                    <button class="btn" type="reset">重置</button>
                </div>
            </div>
        </div>
    </div>

</form>
<!-- 查询评估师 -->
<div id="search" class="bg_f hide">
        <table class="table" border="0" style="width: 100% !important;" id="valuer_id_infos">
            <input type="hidden" name="pinggu_ids" id="pinggu_id" value="">
            <tbody>
            <tr class="noSelect">
                <th class="tc" width="35px">
                    <input class="va_m" type="checkbox" name="" id="allCheck" value="" data-falg="allCheck" onclick="checkBoxOp(this)"/>
                </th>
                <th style="text-align: center;">ID</th>
                <th style="text-align: center;">姓名</th>
                <th style="text-align: center;">注册号</th>
                <th style="text-align: center;">有效期</th>
            </tr>
            </tbody>
        </table>
        <div class="layerBtns">
            <button class="btn" type="button" id="btn-form-search">选择</button>
        </div>
</div>
<script>
    /* ===== 查询权属 及 评估公司 =====*/
    $('.sear_collection_id').change(function () {
        var _item_id=$("#item_id").find('option:selected').val();
        var _community_id=$("#community_id").find('option:selected').val();
        if(_item_id&&!_community_id){
            var data = { 'item_id':_item_id};
        }
        if(_item_id&&_community_id){
            var data = {
                'item_id':_item_id,
                'community_id':_community_id
            };
        }
        if(_item_id){
            $.ajax({
                url:"{:url('Tools/collections')}",
                data:data,
                dataType:'json',
                type:'post',
                success:function (resp) {
                    $('#collection_id_info').html('');
                     var options = '';
                    if(resp.code){
                        options += '<select name="collection_id" id="collection_id" class="chosen" data-placeholder="请选择权属" data-no_results_text="没有匹配数据">';
                        options += ' <option value="">--请选择权属--</option>';
                        $.each(resp.data,function (index,info) {
                               var building = info.building?info.building+"栋":'';
                               var unit = info.unit?info.unit+"单元":'';
                               var floor = info.floor?info.floor+"楼":'';
                               var number = info.number?info.number+"号":'';

                            options += '<option value="'+info.id+'">'+building+unit+floor+number+'（'+info.id+'）'+'</option>';
                        });
                        options += '</select>';
                    }else{
                        options += '<select name="collection_id" id="collection_id" class="chosen" data-placeholder="暂无数据" data-no_results_text="没有匹配数据">';
                        options += ' <option value="">--暂无数据--</option>';
                        layer.msg(resp.msg,function(){});
                    }
                    options += '</select>';
                    $('#collection_id_info').html(options);
                    $("#collection_id").chosen();
                },
                error:function () {
                    layer.msg('网络错误，请重试',function(){});
                }
            });
            $.ajax({
                url:"{:url('Tools/item_company')}",
                data:{ 'item_id':_item_id,'type':0},
                dataType:'json',
                type:'post',
                success:function (resp) {
                    $('#company_id').html('');
                    var options = '';
                    if(resp.code){
                          options += '<option value="">--请选择评估公司--</option>';
                        $.each(resp.data,function (index,info) {
                            options += '<option value="'+info.company_id+'">'+info.company_name+'</option>';
                        });
                    }else{
                        options='<option value="">--暂无数据--</option>';
                        layer.msg(resp.msg,function(){});
                    }
                    $('#company_id').html(options);
                },
                error:function () {
                    layer.msg('网络错误，请重试',function(){});
                }
            });
        }else{
            var options = '';
            options += '<select name="collection_id" id="collection_id" class="chosen" data-placeholder="请选择权属" data-no_results_text="没有匹配数据">';
            options += ' <option value="">--请先选择项目--</option>';
            options += '</select>';
            $('#collection_id_info').html(options);
            $("#collection_id").chosen();

            var options1='<option value="">--请先选择项目--</option>';
            $('#company_id').html(options1);

            layer.msg('请选择项目',function(){});
        }
    });

    /* ===== 查询评估建筑物 =====*/
    $("#collection_id_info").on('change','#collection_id',function () {
        var _collection_id = $("#collection_id").find("option:selected").val();
        if(_collection_id){
            $.ajax({
                url:"{:url('Tools/estate_building')}",
                data:{ 'collection_id':_collection_id},
                dataType:'json',
                type:'post',
                success:function (resp) {
                    $('.tableCons').find('tr:first').siblings().remove();
                    var options = '';
                    if(resp.code){
                        $.each(resp.data,function (index,info) {
                            var remark = info.remark;
                            if(remark==null){
                                remark = '';
                            }

                            options += '<tr class="h50">';
                            options += '<td style="text-align: left;background: none;width: inherit !important;">'+info.id+'</td>';
                            options += '<td  class="nowrap" style="text-align: left;background: none;">'+info.address+'</td>';
                            options += '<td style="text-align: center;background: none;">'+info.bu_name+'</td>';
                            options += '<td style="text-align: center;background: none;">'+info.bs_name+'</td>';
                            options += '<td style="text-align: left;background: none;">'+info.real_num+'</td>';
                            options += '<td style="text-align: center;background: none;">'+info.real_unit+'</td>';
                            options += '<td style="text-align: left;background: none;"><input type="text" name="price['+info.id+']" class="price" value="" data-real_num="'+info.real_num+'" data-id="'+info.id+'" onkeyup="price_num(this)"  onchange="price_num(this)"></td>';
                            options += '<td style="text-align: left;background: none;">'+remark+'</td>';
                            options += '<td style="text-align: left;background: none;"><input type="text" name="amount['+info.id+']" id="total-'+info.id+'"  value="" readonly></td>';
                            options += '</tr>';
                        });
                        $('.tableCons').find('tbody').append(options);

                    }else{
                        layer.msg(resp.msg,function(){});
                    }
                },
                error:function () {
                    layer.msg('网络错误，请重试',function(){});
                }
            });
        }else{
            $('.tableCons').find('tr:first').siblings().remove();
            layer.msg('请选择权属',function(){});
        }
    });
    /* ===== 评估建筑物（单价变化获取总价） =====*/
    function  price_num(obj) {
        var _this = $(obj);
        var price=parseFloat(_this.val());
        var number=parseFloat(_this.data('real_num'));
        var id=_this.data('id');
        var total=price*number;
        if(isNaN(total)){
            $('#total-'+id).val('');
            return false;
        }
        $('#total-'+id).val(total);
    }

    /* ===== 选择评估师按钮赋值 =====*/
    $("#company_id").change(function () {
        var _company_id=$("#company_id").find('option:selected').val();
        $(".valuerid_list").attr('onclick','valuer_id_list('+_company_id+')');
    });
    /* ===== 查询评估师 =====*/
   function valuer_id_list(_company_id){
       if(_company_id){
           layerPage('评估师列表',$('#search'),'650','300');
           $.ajax({
               url:"{:url('Tools/item_company_valuer')}",
               data:{ 'company_id':_company_id},
               dataType:'json',
               type:'post',
               success:function (resp) {
                   $('#valuer_id_infos').find('tr:first').siblings().remove();
                   var options = '';
                   var _checked='';
                   var  idss = $("#pinggu_id").val();
                   if(idss){
                       idss = idss.split(",");
                   }else{
                       idss = [];
                   }
                   if(resp.code){
                       $.each(resp.data,function (index,info) {
                           var res=$.inArray(info.id.toString(),idss);
                           if(res>-1){
                               _checked='checked';
                           }

                           options += '<tr class="h50">';
                           options += ' <td><input class="va_m" type="checkbox" name="ids[]" value="'+info.id+'" onclick="checkBoxOp(this)" id="check-'+info.id+'" '+_checked+'/></td>';
                           options += '<td>'+info.id+'</td>';
                           options += '<td>'+info.name+'</td>';
                           options += '<td>'+info.register_num+'</td>';
                           options += '<td>'+info.valid_at+'</td>';
                           options += '</tr>';
                       });
                       $('#valuer_id_infos').find('tbody').append(options);
                   }else{
                       layer.msg(resp.msg,function(){});
                   }
               },
               error:function () {
                   layer.msg('网络错误，请重试',function(){});
               }
           });

       }else{
           layer.msg('请选择评估公司',function(){});
       }

   }
    /* ===== 选择评估师 =====*/
    $("#btn-form-search").click(function () {
        var ids = '';
        var name_ids= $("input[name='ids[]']:checked");
        for(var i = 0;i<name_ids.length;i++){
            ids += $(name_ids[i]).val();
            if (i < name_ids.length - 1) ids += ",";
        }
        $("#pinggu_id").val(ids);
        $("#valuer_id").val(ids);
        layer.closeAll();
        $.ajax({
            url:"{:url('Tools/item_company_valuer')}",
            data:{ 'ids':ids},
            dataType:'json',
            type:'post',
            success:function (resp) {
                $('#valuer_id_lists').find('tr:first').siblings().remove();
                var options = '';
                if(resp.code){
                    $.each(resp.data,function (index,info) {
                        options += '<tr class="h50">';
                        options += '<td style="text-align: left;background: none;width: inherit !important;">'+info.id+'</td>';
                        options += '<td style="text-align: left;background: none;">'+info.name+'</td>';
                        options += '<td style="text-align: left;background: none;">'+info.register_num+'</td>';
                        options += '<td style="text-align: left;background: none;">'+info.valid_at+'</td>';
                        options += '</tr>';
                    });
                    $('#valuer_id_lists').find('tbody').append(options);
                }else{
                    layer.msg(resp.msg,function(){});
                }
            },
            error:function () {
                layer.msg('网络错误，请重试',function(){});
            }
        });
    });





</script>
</body>
</html>
